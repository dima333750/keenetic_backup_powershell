# keenetic_backup_powershell
Автоматическое резервное копирование настроек Keenetic: надёжно, безопасно и с умной ротацией через powershell
<ul>
 	<li>
<p>создание отдельного пользователя с правами только на чтение;</p>
</li>
 	<li>
<p>безопасную передачу пароля (Base64);</p>
</li>
 	<li>
<p>ротацию бэкапов: ежедневные, еженедельные, ежемесячные и годовые копии.</p>
</li>
</ul>
<h2>1. Подготовка: создаём пользователя backup на Keenetic</h2>
<p>Для безопасности <strong>не используйте учётную запись администратора</strong> в скриптах. В Keenetic (на базе ОС NDMS) можно создать отдельного пользователя с правами <strong>только на чтение</strong> (read-only).</p>
<h3>Как создать:</h3>
<ol>
 	<li>
<p>Зайдите в веб-интерфейс Keenetic.</p>
</li>
 	<li>
<p>Перейдите в раздел <strong>"Управление"</strong> > <strong>"Пользователи"</strong>.</p>
</li>
 	<li>
<p>Нажмите <strong>"Добавить пользователя"</strong>.</p>
</li>
 	<li>
<p>Задайте имя, например <code>backup</code>.</p>
</li>
 	<li>
<p>Установите флажок <strong>"Только чтение"</strong>.</p>
</li>
 	<li>
<p>Придумайте пароль (запишите его, он понадобится позже).</p>
</li>
</ol>
<p>Такой пользователь сможет скачивать конфигурацию (<code>startup-config.txt</code>), но не сможет менять настройки роутера.</p>
<h2>2. Шифрование пароля: почему Base64 и как это сделать</h2>
<p>Хранить пароль в скрипте в открытом виде — плохая практика. Мы используем простое, но эффективное решение: кодирование в Base64. Это не шифрование, но скрывает пароль от "поверхностного" взгляда.</p>
<h3>Кодируем пароль в PowerShell:</h3>
<p>Запустите PowerShell и выполните:</p>
<div>
<div>
<div>
<div>
<div>powershell</div>
</div>
</div>
</div>
<pre>$pass = "ваш_пароль_пользователя_backup"
$bytes = [System.Text.Encoding]::UTF8.GetBytes($pass)
[Convert]::ToBase64String($bytes)</pre>
</div>
<p>Вы получите строку вида <code>0JDRgdCw0L3QvdC+0Y8=</code>. Это и есть ваш закодированный пароль. В скрипте мы будем передавать именно его.</p>
<h2>3. Скрипт автоматического бэкапа</h2>
<p>Скрипт делает следующее:</p>
<ul>
 	<li>
<p>авторизуется на Keenetic по HTTP (используется NDMS-авторизация с вызовом <code>auth</code>);</p>
</li>
 	<li>
<p>скачивает файл <code>startup-config.txt</code>;</p>
</li>
 	<li>
<p>упаковывает его в ZIP с именем, зависящим от даты (daily/weekly/monthly/yearly);</p>
</li>
 	<li>
<p>удаляет старые бэкапы согласно политике ротации.</p>
</li>
</ul>
<h3>Логика ротации:</h3>
<ul>
 	<li>
<p><strong>Daily</strong> — храним 7 последних копий.</p>
</li>
 	<li>
<p><strong>Weekly</strong> (воскресенье) — храним 4 последние копии.</p>
</li>
 	<li>
<p><strong>Monthly</strong> (1 число) — храним 12 последних копий.</p>
</li>
 	<li>
<p><strong>Yearly</strong> (1 января) — храним 20 последних копий.</p>
</li>
</ul>
<h2>4. Настройка планировщика Windows</h2>
<p>Чтобы скрипт выполнялся автоматически, добавим задание в Планировщик задач.</p>
<h3>Шаги:</h3>
<ol>
 	<li>
<p>Откройте <strong>Task Scheduler</strong>.</p>
</li>
 	<li>
<p>Создайте новую задачу:</p>
<ul>
 	<li>
<p><strong>Триггер</strong>: ежедневно, в удобное время (например, 3:00 ночи).</p>
</li>
 	<li>
<p><strong>Действие</strong>: запуск программы <code>powershell.exe</code>.</p>
</li>
 	<li>
<p><strong>Аргументы</strong>:</p>
<div>
<div>
<div>
<div>

</div>
</div>
</div>
<pre>-WindowStyle Hidden -ExecutionPolicy Bypass -File "C:\Scripts\backup_keenetic.ps1" -Password "0JDRgdCw0L3QvdC+0Y8="</pre>
</div></li>
</ul>
</li>
 	<li>
<p>Убедитесь, что задача выполняется от имени пользователя с правами на запись в папку <code>C:\Backups\Keenetic</code>.</p>
</li>
</ol>
<h2>5. Проверка и логирование</h2>
<p>При запуске скрипт выводит в консоль временные метки и статус операций. Для отладки можно запустить его вручную. В фоновом режиме окно PowerShell будет скрыто (<code>-WindowStyle Hidden</code>).</p>
<p>Пример успешного выполнения:</p>
<div>
<div>
<div>
<div>
<div>text</div>
</div>
</div>
</div>
<pre>[12:30:15] Password loaded: ****
[12:30:15] === AUTH ===
[12:30:16] Got challenge
[12:30:16] Auth OK: 200
[12:30:16] Downloading...
[12:30:17] Downloaded: 5842 bytes
[12:30:17] ZIP created: daily-20250213-123015.zip (2143 bytes)
[12:30:17] === ROTATION ===
[12:30:17] Deleted old daily: daily-20250206-030001.zip
[12:30:17] Done</pre>
</div>
<h2>Заключение</h2>
<p>Теперь у вас есть полностью автоматизированная система резервного копирования конфигурации Keenetic с продуманной ротацией. Вы всегда сможете откатиться на нужную версию настроек: от вчерашней до копии годичной давности.</p>
<h3>Плюсы подхода:</h3>
<ul>
 	<li>
<p>Не требует установки дополнительного ПО на роутер.</p>
</li>
 	<li>
<p>Безопасно (read-only пользователь).</p>
</li>
 	<li>
<p>Экономит место за счёт ротации.</p>
</li>
 	<li>
<p>Пароль не светится в открытом виде.</p>
</li>
</ul>
<p>Можно доработать скрипт под себя: добавить отправку уведомлений по почте или в Telegram, копирование бэкапов в облако и т.д.</p>
<p>Удачи в автоматизации!</p>
